services:
  vmware-inventory:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
        - APP_VERSION=${APP_VERSION:-latest}
        - BUILD_DATE=${BUILD_DATE}
        - VCS_REF=${VCS_REF}
    image: vmware-inventory-dashboard:${APP_VERSION:-latest}
    container_name: ${CONTAINER_NAME}
    
    # Port mapping
    ports:
      - "${HOST_PORT}:${CONTAINER_PORT}"
    
    # Volume mounts
    volumes:
      # Persistent database storage
      - vmware-data:/app/data
      # Container logs storage
      - vmware-logs:/var/log/vmware-inventory
      # Optional: mount external config
      # - ./config:/app/config:ro
    
    # Environment variables
    environment:
      - VMWARE_INV_DB_URL=${VMWARE_INV_DB_URL}
      - STREAMLIT_SERVER_HEADLESS=${STREAMLIT_SERVER_HEADLESS}
      - STREAMLIT_SERVER_ENABLE_CORS=${STREAMLIT_SERVER_ENABLE_CORS}
      - STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=${STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION}
    
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT}'
          memory: ${MEMORY_LIMIT}
        reservations:
          cpus: '${CPU_RESERVATION}'
          memory: ${MEMORY_RESERVATION}
    
    # Restart policy
    restart: ${RESTART_POLICY}
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:${CONTAINER_PORT}/_stcore/health', timeout=5)"]
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE}"
        max-file: "${LOG_MAX_FILE}"
        compress: "${LOG_COMPRESS}"
        labels: "com.vmware.inventory.component,com.vmware.inventory.version"
        tag: "{{.Name}}/{{.ID}}"
    
    # Network
    networks:
      - vmware-network
    
    # Labels for container management
    labels:
      com.vmware.inventory.description: "VMware vSphere Inventory Dashboard"
      com.vmware.inventory.version: "${APP_VERSION}"
      com.vmware.inventory.component: "dashboard"

# Named volumes for data persistence
volumes:
  vmware-data:
    driver: local
    labels:
      com.vmware.inventory.description: "VMware inventory database storage"
  
  vmware-logs:
    driver: local
    labels:
      com.vmware.inventory.description: "VMware inventory container logs storage"

# Network configuration
networks:
  vmware-network:
    driver: bridge
    labels:
      com.vmware.inventory.description: "VMware inventory dashboard network"
